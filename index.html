<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Activity - Start Up Early</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Light gray background like in screenshots */
        }
        .sidebar-link.active {
            background-color: #f5f3ff; /* Lightest purple */
            color: #5b21b6; /* Darker purple */
            font-weight: 600;
        }
        .form-progress-item.active {
            background-color: #e9d5ff; /* Light purple */
            color: #5b21b6; /* Darker purple */
            font-weight: 600;
        }
        .form-progress-item.active .progress-circle {
            background-color: #5b21b6; /* Darker purple */
            color: white;
        }
        .progress-circle {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-right: 8px;
            font-size: 0.875rem;
            border: 1px solid #d1d5db;
        }
        .form-progress-item.completed .progress-circle {
            background-color: #34d399; /* Green for completed */
            border-color: #34d399;
            color: white;
        }
        .info-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background-color: #e5e7eb;
            color: #6b7280;
            font-size: 0.75rem;
            font-weight: bold;
            cursor: help;
        }
        /* Custom file input */
        .custom-file-input::-webkit-file-upload-button {
            visibility: hidden;
        }
        .custom-file-input::before {
            content: 'Choose File';
            display: inline-block;
            background: #f3f4f6; /* Light gray */
            border: 1px solid #d1d5db; /* Gray border */
            border-radius: 0.375rem; /* Rounded corners */
            padding: 0.5rem 1rem;
            outline: none;
            white-space: nowrap;
            -webkit-user-select: none;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.875rem;
            color: #374151; /* Dark gray text */
        }
        .custom-file-input:hover::before {
            border-color: #9ca3af;
        }
        .custom-file-input:active::before {
            background: -webkit-linear-gradient(top, #e3e3e3, #f9f9f9);
        }
        .form-input, .form-select, .form-textarea {
            border-color: #d1d5db;
        }
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            border-color: #6366f1; /* Indigo */
            box-shadow: 0 0 0 1px #6366f1;
        }
        .primary-btn {
            background-color: #5b21b6; /* Purple */
            color: white;
        }
        .primary-btn:hover {
            background-color: #4c1d95; /* Darker Purple */
        }
        .secondary-btn {
            background-color: #e5e7eb; /* Light Gray */
            color: #374151; /* Dark Gray text */
        }
        .secondary-btn:hover {
            background-color: #d1d5db; /* Gray */
        }
        .tertiary-btn { /* For switching modes */
            background-color: transparent;
            color: #5b21b6; /* Purple text */
            border: 1px solid #5b21b6; /* Purple border */
        }
        .tertiary-btn:hover {
            background-color: #f5f3ff; /* Lightest purple */
        }
        .danger-btn {
            background-color: #ef4444; /* Red */
            color: white;
        }
        .danger-btn:hover {
            background-color: #dc2626; /* Darker Red */
        }
        /* Chatbot placeholder styles */
        .chat-message {
            padding: 8px 12px;
            border-radius: 12px;
            margin-bottom: 8px;
            max-width: 80%; /* Increased max-width */
            word-wrap: break-word;
            line-height: 1.5;
        }
        .user-message {
            background-color: #5b21b6; /* Purple */
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 0px;
        }
        .bot-message {
            background-color: #e5e7eb; /* Light gray */
            color: #1f2937; /* Dark gray text */
            align-self: flex-start;
            border-bottom-left-radius: 0px;
        }
         .loading-dots span {
            display: inline-block;
            width: 8px;
            height: 8px;
            background-color: #6b7280;
            border-radius: 50%;
            animation: loadingPulse 1.4s infinite ease-in-out both;
        }
        .loading-dots span:nth-child(1) { animation-delay: -0.32s; }
        .loading-dots span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes loadingPulse {
            0%, 80%, 100% { opacity: 0.3; transform: scale(0.7); }
            40% { opacity: 1; transform: scale(1); }
        }
        /* Quick Entry List Styles */
        .quick-entry-row {
            display: grid;
            grid-template-columns: repeat(2, 1fr) auto; 
            gap: 0.75rem; /* 12px */
            align-items: end; 
            padding: 0.75rem;
            border-bottom: 1px solid #e5e7eb; 
        }
         @media (min-width: 768px) { /* md breakpoint */
            .quick-entry-row {
                grid-template-columns: 2fr 1.5fr 1.5fr 1fr 1fr auto;
            }
        }
        /* Timeline styles */
        .timeline-item {
            position: relative;
            padding-left: 2.5rem; /* 40px */
            padding-bottom: 2rem; /* 32px */
            border-left: 2px solid #e5e7eb; /* Gray border */
        }
        .timeline-item:last-child {
            border-left: 2px solid transparent;
        }
        .timeline-icon {
            position: absolute;
            left: -13px; /* Center the icon on the line */
            top: 0;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

    </style>
</head>
<body class="flex min-h-screen">
    <!-- Sidebar (Mimicking the layout) -->
    <div class="w-64 bg-white p-6 shadow-lg hidden md:flex flex-col">
        <div class="mb-10">
            <img src="https://placehold.co/150x40/6724F5/FFFFFF?text=StartUpEarly&font=inter" alt="Start Up Early Logo" class="h-8">
        </div>
        <nav id="sidebarNav" class="space-y-2">
            <a href="#" class="sidebar-link block px-4 py-2 text-gray-700 rounded-md hover:bg-gray-100" onclick="showView('dashboardView', this)">Dashboard</a>
            <a href="#" class="sidebar-link block px-4 py-2 text-gray-700 rounded-md" onclick="showView('formView', this)">Add Activity</a>
            <a href="#" class="sidebar-link block px-4 py-2 text-gray-700 rounded-md" onclick="showView('timelineView', this)">Timeline</a>
            <a href="#" class="sidebar-link block px-4 py-2 text-gray-700 rounded-md" onclick="alert('Not implemented')">CCAs</a>
            <a href="#" class="sidebar-link block px-4 py-2 text-gray-700 rounded-md" onclick="alert('Not implemented')">Events</a>
            <a href="#" class="sidebar-link block px-4 py-2 text-gray-700 rounded-md" onclick="alert('Not implemented')">My Attendance</a>
            <a href="#" class="sidebar-link block px-4 py-2 text-gray-700 rounded-md" onclick="alert('Not implemented')">Calendar</a>
            <a href="#" class="sidebar-link block px-4 py-2 text-gray-700 rounded-md" onclick="alert('Not implemented')">Portal Links</a>
            <a href="#" class="sidebar-link block px-4 py-2 text-gray-700 rounded-md" onclick="alert('Not implemented')">Resources</a>
        </nav>
        <div class="mt-auto">
             <button class="w-full flex items-center justify-center px-4 py-2 text-purple-600 border border-purple-600 rounded-md hover:bg-purple-50">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15M12 9l-3 3m0 0l3 3m-3-3h12.75" />
                </svg>
                Logout
            </button>
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="flex-1 p-4 md:p-8 overflow-y-auto">
        <!-- Dashboard Placeholder View -->
        <div id="dashboardView" class="hidden">
            <h1 class="text-3xl font-bold text-gray-800">Dashboard</h1>
            <p class="text-gray-600 mt-2">Welcome to your dashboard. This is a placeholder.</p>
        </div>

        <!-- Form View Container -->
        <div id="formView" class="hidden">
            <div class="mb-6 p-4 bg-gray-100 rounded-lg shadow">
                <h2 class="text-xl font-semibold text-gray-700 mb-3">Add Your Activity</h2>
                <p class="text-sm text-gray-600 mb-3">You are currently using the guided form. You can also switch to other methods:</p>
                <div class="flex flex-col sm:flex-row gap-3">
                    <button onclick="showView('quickEntryView')" class="w-full sm:w-auto tertiary-btn py-2 px-4 rounded-md text-sm font-medium">
                        Use Quick Entry (for multiple activities)
                    </button>
                    <button onclick="startChatbot()" class="w-full sm:w-auto tertiary-btn py-2 px-4 rounded-md text-sm font-medium">
                        Chat with AI Assistant
                    </button>
                </div>
            </div>

            <!-- Step 0: Select Experience Type & Activity -->
            <div id="formStep0" class="bg-white p-6 md:p-8 rounded-lg shadow-xl mb-6">
                 <h3 class="text-lg md:text-xl font-bold text-gray-800 mb-1">Step 1: Select Experience Type & Activity</h3>
                 <p class="text-gray-600 mb-6 text-sm">Help us understand the nature of your activity.</p>
                
                <div class="mb-4">
                    <label for="experienceType" class="block text-sm font-medium text-gray-700 mb-1">Select experience type <span class="info-icon">i</span></label>
                    <select id="experienceType" name="experienceType" class="form-select mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500 sm:text-sm">
                        <!-- Options populated by JS -->
                    </select>
                </div>
                <div class="mb-6">
                    <label for="activityType" class="block text-sm font-medium text-gray-700 mb-1">Activity Type / Field <span class="info-icon">i</span></label>
                    <input type="text" id="activityType" name="activityType" class="form-input mt-1 block w-full py-2 px-3 rounded-md shadow-sm sm:text-sm" placeholder="e.g., Performing Arts, Medical Research">
                </div>
                <div class="flex justify-end">
                    <button onclick="nextFormStep()" class="primary-btn py-2 px-6 rounded-md text-sm font-medium">Next Step</button>
                </div>
            </div>

            <!-- Main multi-step form area -->
            <div id="mainFormArea" class="hidden bg-white p-6 md:p-8 rounded-lg shadow-xl">
                 <div class="flex flex-col md:flex-row gap-6">
                    <!-- Form Progress Indicator -->
                    <div class="w-full md:w-1/4 bg-purple-50 p-4 rounded-lg">
                        <h3 class="text-lg font-semibold text-purple-700 mb-4">Form progress</h3>
                        <p class="text-xs text-purple-500 mb-4">Indicators for form progress</p>
                        <nav id="formProgressNav" class="space-y-1">
                            <!-- Progress items will be dynamically created here -->
                        </nav>
                    </div>

                    <!-- Form Steps Content -->
                    <div class="w-full md:w-3/4">
                        <div id="formStep1" class="form-step">
                            <h2 class="text-xl font-bold text-gray-800 mb-1">Your Activity Details</h2>
                            <p class="text-gray-600 mb-6 text-sm">Now let's get into the specifics!</p>
                            
                            <div class="mb-4">
                                <label for="activityName" class="block text-sm font-medium text-gray-700 mb-1">Activity Name <span class="info-icon">i</span></label>
                                <input type="text" id="activityName" name="activityName" class="form-input mt-1 block w-full py-2 px-3 rounded-md shadow-sm sm:text-sm" placeholder="Enter Activity Name" maxlength="50">
                                <p class="text-xs text-gray-500 mt-1 text-right"><span id="activityNameCount">0</span>/50</p>
                            </div>
                            <div class="mb-4">
                                <label for="activityDetails" class="block text-sm font-medium text-gray-700 mb-1">Activity Details (optional) <span class="info-icon">i</span></label>
                                <textarea id="activityDetails" name="activityDetails" rows="3" class="form-textarea mt-1 block w-full py-2 px-3 rounded-md shadow-sm sm:text-sm" placeholder="Write activity details" maxlength="200"></textarea>
                                <p class="text-xs text-gray-500 mt-1 text-right"><span id="activityDetailsCount">0</span>/200</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Upload Proof (optional) <span class="info-icon">i</span></label>
                                <div class="mt-1 flex items-center">
                                    <input type="file" id="activityProof" name="activityProof" class="custom-file-input text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-purple-50 file:text-purple-700 hover:file:bg-purple-100">
                                    <span id="fileName" class="ml-3 text-sm text-gray-500">No file chosen</span>
                                </div>
                            </div>
                        </div>

                        <div id="formStep2" class="form-step hidden">
                            <h2 class="text-xl font-bold text-gray-800 mb-1">Time Frame</h2>
                            <p class="text-gray-600 mb-6 text-sm">Let us know when your activity took place.</p>
                            <div class="mb-4">
                                <label for="startDate" class="block text-sm font-medium text-gray-700 mb-1">Select Start Date <span class="info-icon">i</span></label>
                                <input type="date" id="startDate" name="startDate" class="form-input mt-1 block w-full py-2 px-3 rounded-md shadow-sm sm:text-sm">
                            </div>
                            <div>
                                <label for="endDate" class="block text-sm font-medium text-gray-700 mb-1">Select End Date <span class="info-icon">i</span></label>
                                <input type="date" id="endDate" name="endDate" class="form-input mt-1 block w-full py-2 px-3 rounded-md shadow-sm sm:text-sm">
                            </div>
                        </div>

                        <div id="formStep3" class="form-step hidden">
                            <h2 class="text-xl font-bold text-gray-800 mb-1">Impact</h2>
                            <p class="text-gray-600 mb-6 text-sm">Tell us how far your activity reached!</p>
                            <div class="mb-4">
                                <label for="scope" class="block text-sm font-medium text-gray-700 mb-1">Scope <span class="info-icon">i</span></label>
                                <select id="scope" name="scope" class="form-select mt-1 block w-full py-2 px-3 rounded-md shadow-sm sm:text-sm">
                                    <!-- Options populated by JS -->
                                </select>
                            </div>
                        </div>
                        
                        <div id="formStep4" class="form-step hidden">
                            <h2 class="text-xl font-bold text-gray-800 mb-1">Effort</h2>
                            <p class="text-gray-600 mb-6 text-sm">How much time and energy did you dedicate?</p>
                            <div class="mb-4">
                                <label for="engagement" class="block text-sm font-medium text-gray-700 mb-1">Engagement <span class="info-icon">i</span></label>
                                <select id="engagement" name="engagement" class="form-select mt-1 block w-full py-2 px-3 rounded-md shadow-sm sm:text-sm">
                                    <!-- Options populated by JS -->
                                </select>
                            </div>
                        </div>

                        <div id="formStep5" class="form-step hidden">
                            <h2 class="text-xl font-bold text-gray-800 mb-1">Your Role</h2>
                            <p class="text-gray-600 mb-6 text-sm">What was your position in this activity?</p>
                            <div id="roleContent" class="p-4 bg-gray-50 rounded-md text-sm text-gray-700">
                                No specific roles are available for this activity type. Your participation will be recorded as a standard participant.
                                <input type="text" id="roleInput" name="roleInput" class="form-input mt-2 block w-full py-2 px-3 rounded-md shadow-sm sm:text-sm hidden" placeholder="Specify your role">
                            </div>
                        </div>

                        <div id="formStep6" class="form-step hidden">
                            <h2 class="text-xl font-bold text-gray-800 mb-1">Grade Level</h2>
                            <p class="text-gray-600 mb-6 text-sm">Which grade were you in during this activity?</p>
                            <div class="mb-4">
                                <label for="grade" class="block text-sm font-medium text-gray-700 mb-1">Add Grade <span class="info-icon">i</span></label>
                                <input type="number" id="grade" name="grade" class="form-input mt-1 block w-full py-2 px-3 rounded-md shadow-sm sm:text-sm" placeholder="e.g., 10">
                            </div>
                        </div>

                        <div id="formStep7" class="form-step hidden">
                            <h2 class="text-xl font-bold text-gray-800 mb-1">Review Your Activity</h2>
                            <p class="text-gray-600 mb-6 text-sm">Please review all details before submitting.</p>
                            <div id="reviewContent" class="space-y-3 text-sm">
                                <!-- Review details will be populated here -->
                            </div>
                        </div>

                        <!-- Navigation Buttons -->
                        <div class="mt-8 flex justify-between">
                            <button id="backButton" onclick="prevFormStep()" class="secondary-btn py-2 px-6 rounded-md text-sm font-medium">Back</button>
                            <button id="nextButton" onclick="nextFormStep()" class="primary-btn py-2 px-6 rounded-md text-sm font-medium">Next Step</button>
                            <button id="saveButton" onclick="saveActivity()" class="primary-btn py-2 px-6 rounded-md text-sm font-medium hidden">Save Activity</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chatbot View -->
        <div id="chatbotView" class="hidden">
             <div class="max-w-2xl mx-auto bg-white p-6 rounded-lg shadow-xl">
                 <div class="flex items-center justify-between mb-4 border-b pb-3">
                    <h2 class="text-xl font-semibold text-gray-800">AI Assistant</h2>
                    <button onclick="showView('formView')" class="text-sm text-purple-600 hover:text-purple-800">Back to Form</button>
                </div>
                <div id="chatMessages" class="h-96 overflow-y-auto mb-4 p-3 bg-gray-50 rounded-md flex flex-col space-y-2"></div>
                <div id="chatLoadingIndicator" class="hidden items-center justify-center my-2">
                    <div class="loading-dots"><span></span><span></span><span></span></div>
                    <p class="ml-2 text-sm text-gray-500">AI Assistant is typing...</p>
                </div>
                <div class="flex">
                    <input type="text" id="chatInput" placeholder="Type your message..." class="form-input flex-1 py-2 px-3 rounded-l-md focus:ring-0" disabled>
                    <button id="chatSendButton" onclick="sendChatMessageToAI()" class="primary-btn px-4 rounded-r-md" disabled>Send</button>
                </div>
            </div>
        </div>
        
        <!-- Quick Entry List View -->
        <div id="quickEntryView" class="hidden">
             <div class="bg-white p-6 md:p-8 rounded-lg shadow-xl">
                 <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl md:text-2xl font-bold text-gray-800">Quick Entry for Multiple Activities</h2>
                    <button onclick="showView('formView')" class="secondary-btn py-2 px-4 rounded-md text-sm font-medium">Back to Form</button>
                </div>
                <p class="text-gray-600 mb-6 text-sm">Quickly add the basic details for multiple activities below. You can add more details later if needed.</p>
                <div id="quickEntryRowsContainer" class="mb-6 space-y-4"></div>
                <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
                    <button onclick="addQuickEntryRow()" class="w-full sm:w-auto primary-btn py-2 px-4 rounded-md text-sm font-medium flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-2">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                        </svg>
                        Add Another Activity
                    </button>
                    <button onclick="saveAllQuickEntries()" class="w-full sm:w-auto primary-btn bg-green-600 hover:bg-green-700 py-2 px-6 rounded-md text-sm font-medium">Save All Activities</button>
                </div>
            </div>
        </div>

        <!-- Timeline View -->
        <div id="timelineView" class="hidden">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-3xl font-bold text-gray-800">Activities Timeline</h1>
                <button onclick="renderTimeline()" class="secondary-btn p-2 rounded-full" title="Refresh Timeline">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0011.664 0l3.181-3.183m-3.181-3.183l-3.181-3.182a8.25 8.25 0 00-11.664 0l-3.181 3.182m3.181 3.183A8.25 8.25 0 005.175 9.348h4.992" />
                    </svg>
                </button>
            </div>
            <div id="timelineContainer"></div>
        </div>
    </div>

    <script>
        // --- GLOBAL STATE ---
        let currentView = 'formView'; 
        let currentFormStep = 0; 
        let quickEntryRowCounter = 0;
        let allActivities = []; 

        // --- CONSTANTS ---
        const totalFormSteps = 7; 
        const OPENAI_API_KEY = "YOUR_OPENAI_API_KEY_HERE"; // IMPORTANT: Replace with your actual key
        const OPENAI_API_URL = "https://api.openai.com/v1/chat/completions";
        
        const experienceTypes = ["Certification/Recognition", "Internships", "Event Organization", "Event/Activity Participation", "Event Competition", "Club Membership"];
        const masterActivityTypes = ["Soccer", "American Football", "Model United Nations (MUN)", "Debate Club", "Science Fair", "Volunteering at Animal Shelter", "Community Cleanup", "Hackathon", "Chess Club", "Basketball", "Art Exhibition"]; // Placeholder Master List
        const scopeOptions = ["Section", "Class", "School", "Local", "Region", "State/Province", "National", "International", "Global"];
        const engagementOptions = ["Low - (1-2 Hours) / week", "Moderate - (3-5 Hours) / week", "Heavy - (4-6 Hours) / week", "Extra - (7+ Hours) / week"];
        
        const formProgressSteps = [
            { id: 1, label: 'Activity' }, { id: 2, label: 'Duration' },
            { id: 3, label: 'Scope' }, { id: 4, label: 'Engagement' },
            { id: 5, label: 'Role' }, { id: 6, label: 'Grade' },
            { id: 7, label: 'Overview' }
        ];

        // Standard form data object
        const activityData = {
            experienceType: '', activityType: '', activityName: '',
            activityDetails: '', activityProof: null, startDate: '',
            endDate: '', scope: '', engagement: '',
            role: '', grade: ''
        };

        // Chatbot specific state
        let chatbotState = 'INIT';
        let currentActivityDataForChatbot = {};
        let chatHistory = [];

        // --- DOM ELEMENTS CACHE ---
        const views = {
            dashboardView: document.getElementById('dashboardView'),
            formView: document.getElementById('formView'),
            chatbotView: document.getElementById('chatbotView'),
            quickEntryView: document.getElementById('quickEntryView'), 
            timelineView: document.getElementById('timelineView'),
            formStep0: document.getElementById('formStep0'), 
            mainFormArea: document.getElementById('mainFormArea') 
        };
        const chatInputEl = document.getElementById('chatInput');
        const chatSendButton = document.getElementById('chatSendButton');
        const chatMessagesDiv = document.getElementById('chatMessages');
        const chatLoadingIndicator = document.getElementById('chatLoadingIndicator');
        const quickEntryRowsContainer = document.getElementById('quickEntryRowsContainer');
        const timelineContainer = document.getElementById('timelineContainer');
        const formProgressNav = document.getElementById('formProgressNav');

        // --- MAIN APP LOGIC ---

        function showView(viewName, clickedLink = null) {
            currentView = viewName;
            for (const key in views) {
                if (views[key]) views[key].classList.add('hidden');
            }
            if (views[viewName]) views[viewName].classList.remove('hidden');

            const sidebarLinks = document.querySelectorAll('#sidebarNav .sidebar-link');
            sidebarLinks.forEach(link => link.classList.remove('active'));
            if (clickedLink) {
                clickedLink.classList.add('active');
            } else { 
                if (viewName === 'timelineView') document.querySelector('a[onclick*="timelineView"]').classList.add('active');
                else if (viewName === 'formView' || viewName === 'quickEntryView' || viewName === 'chatbotView') document.querySelector('a[onclick*="formView"]').classList.add('active');
                else if (viewName === 'dashboardView') document.querySelector('a[onclick*="dashboardView"]').classList.add('active');
            }

            if (viewName === 'formView') {
                updateFormStepVisibility(); 
            } else if (viewName === 'quickEntryView') {
                if (quickEntryRowsContainer && quickEntryRowsContainer.children.length === 0) {
                    addQuickEntryRow();
                }
            } else if (viewName === 'timelineView') {
                renderTimeline();
            }
        }

        // --- FORM LOGIC ---
        function collectFullFormData() {
            if(document.getElementById('experienceType')) activityData.experienceType = document.getElementById('experienceType').value;
            if(document.getElementById('activityType')) activityData.activityType = document.getElementById('activityType').value;
            if(document.getElementById('activityName')) activityData.activityName = document.getElementById('activityName').value;
            if(document.getElementById('activityDetails')) activityData.activityDetails = document.getElementById('activityDetails').value;
            if(document.getElementById('activityProof')) activityData.activityProof = document.getElementById('activityProof').files[0] || null;
            if(document.getElementById('startDate')) activityData.startDate = document.getElementById('startDate').value;
            if(document.getElementById('endDate')) activityData.endDate = document.getElementById('endDate').value;
            if(document.getElementById('scope')) activityData.scope = document.getElementById('scope').value;
            if(document.getElementById('engagement')) activityData.engagement = document.getElementById('engagement').value;
            const roleInput = document.getElementById('roleInput');
            if(roleInput) activityData.role = roleInput.classList.contains('hidden') ? "Standard Participant" : roleInput.value;
            if(document.getElementById('grade')) activityData.grade = document.getElementById('grade').value;
        }
        
        function nextFormStep() {
            collectFullFormData(); 
            if (currentFormStep === 0) {
                 currentFormStep = 1; 
                 updateFormStepVisibility();
            } else if (currentFormStep < totalFormSteps) {
                currentFormStep++;
                updateFormStepVisibility();
                if (currentFormStep === totalFormSteps) { 
                    renderReview();
                }
            }
        }

        function prevFormStep() {
            if (currentFormStep > 1) { 
                currentFormStep--;
                updateFormStepVisibility();
            } else if (currentFormStep === 1) { 
                currentFormStep = 0;
                updateFormStepVisibility();
            }
        }
        
        function goToFormStep(stepNumber) {
            if (stepNumber > 0 && stepNumber <= totalFormSteps) { 
                let highestCompleted = getHighestCompletedStepMainForm() + 1; 
                if (highestCompleted < 1) highestCompleted = 1; 

                if (stepNumber <= highestCompleted || stepNumber === 1) {
                     collectFullFormData(); 
                     currentFormStep = stepNumber;
                     updateFormStepVisibility();
                     if (currentFormStep === totalFormSteps) {
                         renderReview();
                     }
                } else {
                    alert("Please complete the previous steps first.");
                }
            }
        }

        function getHighestCompletedStepMainForm() {
            let highest = 0; 
            if (activityData.activityName) highest = 1;
            if (activityData.startDate && activityData.endDate) highest = 2;
            if (activityData.scope && activityData.scope !== "Choose Scope") highest = 3;
            if (activityData.engagement && activityData.engagement !== "Choose Engagement") highest = 4;
            if (activityData.role) highest = 5; 
            if (activityData.grade) highest = 6;
            return highest;
        }

        function renderReview() {
            collectFullFormData(); 
            const reviewContentEl = document.getElementById('reviewContent');
            if(reviewContentEl) {
                reviewContentEl.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-4 gap-y-2">
                        <p><strong>Experience Type:</strong></p><p>${activityData.experienceType || 'N/A'}</p>
                        <p><strong>Activity Type / Field:</strong></p><p>${activityData.activityType || 'N/A'}</p>
                        <p><strong>Activity Name:</strong></p><p>${activityData.activityName || 'N/A'}</p>
                        <p><strong>Start Date:</strong></p><p>${activityData.startDate || 'N/A'}</p>
                        <p><strong>End Date:</strong></p><p>${activityData.endDate || 'N/A'}</p>
                        <p><strong>Scope:</strong></p><p>${activityData.scope || 'N/A'}</p>
                        <p><strong>Engagement:</strong></p><p>${activityData.engagement || 'N/A'}</p>
                        <p><strong>Role:</strong></p><p>${activityData.role || 'N/A'}</p>
                        <p><strong>Grade:</strong></p><p>${activityData.grade || 'N/A'}</p>
                        <p class="md:col-span-2"><strong>Details:</strong></p><p class="md:col-span-2">${activityData.activityDetails || 'No details provided'}</p>
                        <p><strong>Proof:</strong></p><p>${activityData.activityProof ? activityData.activityProof.name : 'No proof uploaded'}</p>
                    </div>
                `;
            }
        }
        
        function updateFormStepVisibility() {
            const formSteps = document.querySelectorAll('.form-step');
            if (currentFormStep === 0) { 
                if(views.formStep0) views.formStep0.classList.remove('hidden');
                if(views.mainFormArea) views.mainFormArea.classList.add('hidden');
            } else { 
                if(views.formStep0) views.formStep0.classList.add('hidden');
                if(views.mainFormArea) views.mainFormArea.classList.remove('hidden');

                formSteps.forEach((step, index) => {
                    if (step) step.classList.toggle('hidden', (index + 1) !== currentFormStep);
                });
                updateProgressIndicator();
            }
             const backButton = document.getElementById('backButton');
             const nextButton = document.getElementById('nextButton');
             const saveButton = document.getElementById('saveButton');
             if(backButton) backButton.style.display = currentFormStep > 0 ? 'inline-flex' : 'none';
             if(nextButton) nextButton.style.display = currentFormStep < totalFormSteps ? 'inline-flex' : 'none';
             if(saveButton) saveButton.style.display = currentFormStep === totalFormSteps ? 'inline-flex' : 'none';
        }
        
        function updateProgressIndicator() {
            formProgressNav.innerHTML = formProgressSteps.map(step => {
                let statusClass = '';
                let circleContent = step.id;
                if (step.id < currentFormStep) {
                    statusClass = 'completed';
                    circleContent = '&#10003;';
                } else if (step.id === currentFormStep) {
                    statusClass = 'active';
                }
                return `<a href="#" id="progress-${step.id}" class="form-progress-item flex items-center px-3 py-2.5 text-sm text-gray-700 rounded-md ${statusClass}" onclick="goToFormStep(${step.id}); return false;">
                            <span class="progress-circle">${circleContent}</span> ${step.label}
                        </a>`;
            }).join('');
        }

        function saveActivity() {
            collectFullFormData(); 
            const newActivity = { ...activityData, status: 'Approved' };
            allActivities.unshift(newActivity); 
            console.log("Activity Saved:", newActivity);
            alert("Activity Saved!\nYou will now be taken to the timeline.");
            showView('timelineView', document.querySelector('a[onclick*="timelineView"]'));
        }

        // --- QUICK ENTRY LOGIC ---
         function addQuickEntryRow() {
            quickEntryRowCounter++;
            const rowId = `quickRow-${quickEntryRowCounter}`;
            const newRow = document.createElement('div');
            newRow.classList.add('quick-entry-row', 'bg-gray-50', 'rounded-md');
            newRow.id = rowId;
            newRow.innerHTML = `
                <div>
                    <label class="block text-xs font-medium text-gray-600 mb-0.5">Activity Name</label>
                    <input type="text" name="qe_activityName" class="form-input mt-0.5 block w-full py-1.5 px-2 rounded-md shadow-sm sm:text-sm text-xs" placeholder="e.g., Debate Club">
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-600 mb-0.5">Experience Type</label>
                    <select name="qe_experienceType" class="form-select mt-0.5 block w-full py-1.5 px-2 rounded-md shadow-sm sm:text-sm text-xs">
                        ${experienceTypes.map(o => `<option>${o}</option>`).join('')}
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-600 mb-0.5">Activity Type / Field</label>
                    <input type="text" name="qe_activityType" class="form-input mt-0.5 block w-full py-1.5 px-2 rounded-md shadow-sm sm:text-sm text-xs" placeholder="e.g., Arts">
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-600 mb-0.5">Start Date</label>
                    <input type="date" name="qe_startDate" class="form-input mt-0.5 block w-full py-1.5 px-2 rounded-md shadow-sm sm:text-sm text-xs">
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-600 mb-0.5">End Date</label>
                    <input type="date" name="qe_endDate" class="form-input mt-0.5 block w-full py-1.5 px-2 rounded-md shadow-sm sm:text-sm text-xs">
                </div>
                <button onclick="removeQuickEntryRow('${rowId}')" class="danger-btn p-2 rounded-md text-xs self-end h-9 w-9 flex items-center justify-center" title="Remove Activity">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 12h-15" />
                    </svg>
                </button>
            `;
            if(quickEntryRowsContainer) quickEntryRowsContainer.appendChild(newRow);
        }

        function removeQuickEntryRow(rowId) {
            const rowToRemove = document.getElementById(rowId);
            if (rowToRemove) rowToRemove.remove();
        }

        function saveAllQuickEntries() {
            if(!quickEntryRowsContainer) return;
            const rows = quickEntryRowsContainer.querySelectorAll('.quick-entry-row');
            let entriesAdded = 0;
            rows.forEach((row) => {
                const entry = {
                    activityName: row.querySelector('input[name="qe_activityName"]').value,
                    experienceType: row.querySelector('select[name="qe_experienceType"]').value,
                    activityType: row.querySelector('input[name="qe_activityType"]').value,
                    startDate: row.querySelector('input[name="qe_startDate"]').value,
                    endDate: row.querySelector('input[name="qe_endDate"]').value,
                    scope: 'N/A', engagement: 'N/A', role: 'Participant',
                    grade: 'N/A', activityDetails: '', status: 'Approved'
                };
                if (entry.activityName.trim() !== "") {
                    allActivities.unshift(entry);
                    entriesAdded++;
                }
            });

            if (entriesAdded > 0) {
                console.log("Quick Entries Saved:", allActivities.slice(0, entriesAdded));
                alert(`${entriesAdded} activit(y/ies) saved! You will now be taken to the timeline.`);
                showView('timelineView', document.querySelector('a[onclick*="timelineView"]'));
            } else {
                alert("No activities entered or no activity names provided.");
            }
        }

        // --- CHATBOT LOGIC ---
        function startChatbot() {
            showView('chatbotView');
            chatHistory = []; 
            currentActivityDataForChatbot = {};
            chatbotState = 'INIT';
            if(chatMessagesDiv) chatMessagesDiv.innerHTML = ''; 
            if(chatInputEl) chatInputEl.value = '';
            if(chatInputEl) chatInputEl.disabled = true;
            if(chatSendButton) chatSendButton.disabled = true;
            
            addMessageToChatInterface(`Hi! I'm your AI assistant. Let's add your activity.\n\nFirst, what type of experience was this? The options are: ${experienceTypes.join(", ")}.`, 'bot');
            chatbotState = 'ASKING_EXPERIENCE_TYPE';
            if(chatInputEl) chatInputEl.disabled = false;
            if(chatSendButton) chatSendButton.disabled = false;
        }

        function addMessageToChatInterface(message, sender) {
            if (!chatMessagesDiv) return;
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('chat-message', sender === 'user' ? 'user-message' : 'bot-message');
            messageDiv.textContent = message;
            chatMessagesDiv.appendChild(messageDiv);
            chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;
        }

        async function sendChatMessageToAI() {
            if (OPENAI_API_KEY === "YOUR_OPENAI_API_KEY_HERE") {
                addMessageToChatInterface("The OpenAI API key is not set up. Please add your key to the script to enable the chatbot.", "bot");
                return;
            }
            const userMessageText = chatInputEl.value.trim();
            if (userMessageText === '') return;
            
            addMessageToChatInterface(userMessageText, 'user');
            chatHistory.push({ role: "user", content: userMessageText });
            
            chatInputEl.value = '';
            chatInputEl.disabled = true;
            chatSendButton.disabled = true;
            if(chatLoadingIndicator) chatLoadingIndicator.classList.remove('hidden');

            try {
                const botResponseText = await getAIReply();
                addMessageToChatInterface(botResponseText, 'bot');
                chatHistory.push({ role: "assistant", content: botResponseText });
            } catch (error) {
                console.error("Error getting AI reply:", error);
                addMessageToChatInterface("Sorry, I encountered an error. Please check the console for details.", 'bot');
            } finally {
                if(chatLoadingIndicator) chatLoadingIndicator.classList.add('hidden');
                if (chatbotState !== 'FINALIZED' && chatbotState !== 'CONFIRMATION_PENDING') {
                    chatInputEl.disabled = false;
                    chatSendButton.disabled = false;
                    chatInputEl.focus();
                }
            }
        }
        
        if(chatInputEl) {
            chatInputEl.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !chatSendButton.disabled) {
                    sendChatMessageToAI();
                }
            });
        }

        function getSystemPrompt() {
            return `You are a friendly and efficient student assistant. Your goal is to help a student log an extracurricular activity by asking them questions one at a time.
            The final data object you need to fill has the following fields: ${Object.keys(activityData).join(', ')}.
            
            Here are the fixed lists you must use for certain fields:
            - Experience Types: [${experienceTypes.join(", ")}]
            - Master Activity Types: [${masterActivityTypes.join(", ")}]

            Your conversation flow is managed by a state machine. After your conversational response, you MUST provide instructions on a new line in the format "EXTRACTED_VALUE:[value]" and on another new line "SET_STATE:[NEXT_STATE]".
            
            RULES:
            1.  Ask one question at a time.
            2.  For 'experienceType' and 'activityType', if the user's answer is not in the fixed list, you must infer the closest match and ask for confirmation. Do not proceed until the value is confirmed from the list. For example, if they say "I played football" for activity type, you MUST ask "Got it. Do you mean Soccer or American Football?" to get a precise value from your list.
            3.  After you get the final piece of information, summarize everything you've collected and ask for final confirmation from the user.
            4.  If the user confirms the summary, respond with "Great! I've saved your activity: [Activity Name]." and set the state to FINALIZED.
            5.  If the user wants to make a correction, ask them what they'd like to change and set the state to AWAITING_CORRECTION.
            `;
        }

        async function getAIReply() {
            const messages = [
                { role: "system", content: getSystemPrompt() },
                ...chatHistory
            ];

            const payload = {
                model: "gpt-3.5-turbo",
                messages: messages
            };

            const response = await fetch(OPENAI_API_URL, {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${OPENAI_API_KEY}`
                },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`OpenAI API request failed: ${errorData.error.message}`);
            }
            
            const result = await response.json();

            if (result.choices && result.choices[0] && result.choices[0].message) {
                let rawText = result.choices[0].message.content;
                let conversationalText = rawText;
                let extractedValue = null;
                let nextStateInstruction = null;

                const extractedValueMatch = rawText.match(/EXTRACTED_VALUE:(.*)/i);
                if (extractedValueMatch && extractedValueMatch[1]) {
                    extractedValue = extractedValueMatch[1].trim();
                    conversationalText = conversationalText.replace(extractedValueMatch[0], '').trim();
                }
                
                const setStateMatch = rawText.match(/SET_STATE:([A-Z_]+)/i);
                if (setStateMatch && setStateMatch[1]) {
                    nextStateInstruction = setStateMatch[1].trim();
                    conversationalText = conversationalText.replace(setStateMatch[0], '').trim();
                }
                
                updateChatbotData(extractedValue); 
                
                if (nextStateInstruction) {
                    chatbotState = nextStateInstruction;
                }

                if (chatbotState === 'FINALIZED') {
                    const newActivity = { ...currentActivityDataForChatbot, status: 'Approved' };
                    allActivities.unshift(newActivity);
                    setTimeout(() => {
                        showView('timelineView', document.querySelector('a[onclick*="timelineView"]'));
                    }, 2000);
                }
                return conversationalText.trim();
            } else {
                return "I seem to be having trouble thinking. Could you try that again?";
            }
        }
        
        function updateChatbotData(valueFromLLM) {
            if (!valueFromLLM || valueFromLLM.toUpperCase() === 'NONE') return;
            const fieldMap = {
                 'ASKING_EXPERIENCE_TYPE': 'experienceType', 'ASKING_ACTIVITY_TYPE': 'activityType',
                 'ASKING_ACTIVITY_NAME': 'activityName', 'ASKING_START_DATE': 'startDate', 
                 'ASKING_END_DATE': 'endDate', 'ASKING_SCOPE': 'scope', 
                 'ASKING_ENGAGEMENT': 'engagement', 'ASKING_ROLE': 'role', 
                 'ASKING_GRADE': 'grade', 'ASKING_DETAILS_OPTIONAL': 'activityDetails',
                 'ASKING_PROOF_OPTIONAL': 'proofProvided'
            };
            if (fieldMap[chatbotState]) {
                currentActivityDataForChatbot[fieldMap[chatbotState]] = valueFromLLM;
            }
        }
        
        // --- TIMELINE LOGIC ---
        function renderTimeline() {
            if (!timelineContainer) return;
            if (allActivities.length === 0) {
                timelineContainer.innerHTML = `<div class="text-center p-8 bg-white rounded-lg shadow-md">
                    <h2 class="text-xl font-semibold text-gray-700">No activities yet!</h2>
                    <p class="text-gray-500 mt-2">Use the "Add Activity" page to start building your timeline.</p>
                </div>`;
                return;
            }
            timelineContainer.innerHTML = '';
            allActivities.forEach(activity => {
                const itemHTML = createTimelineItem(activity);
                timelineContainer.insertAdjacentHTML('beforeend', itemHTML);
            });
        }
        
        function createTimelineItem(activity) {
            const getDurationInDays = (start, end) => {
                if (!start || !end) return 0;
                const diffTime = Math.abs(new Date(end) - new Date(start));
                return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            };
            const durationDays = getDurationInDays(activity.startDate, activity.endDate);
            return `
            <div class="timeline-item">
                <div class="timeline-icon bg-purple-100 text-purple-600">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M11.48 3.499a.562.562 0 011.04 0l2.125 5.111a.563.563 0 00.475.345h5.364c.518 0 .734.66.331.971l-4.36 3.184a.563.563 0 00-.203.542l1.636 5.028a.562.562 0 01-.84.62l-4.434-3.23a.563.563 0 00-.65 0l-4.434 3.23a.562.562 0 01-.84-.62l1.636-5.028a.563.563 0 00-.203-.542l-4.36-3.184a.563.563 0 01.331-.971h5.364a.563.563 0 00.475-.345L11.48 3.5z" /></svg>
                </div>
                <div class="bg-white p-4 rounded-lg shadow-sm">
                    <div class="flex flex-wrap justify-between items-start gap-2">
                        <h3 class="font-bold text-lg text-gray-800">${activity.activityName || 'Unnamed Activity'}</h3>
                        <div class="flex items-center gap-2">
                            <span class="text-xs font-semibold text-gray-600 bg-gray-100 px-2 py-1 rounded-full">${activity.role || 'Participant'}</span>
                            <span class="text-xs font-bold text-green-700 bg-green-100 px-2 py-1 rounded-full">${activity.status || 'Pending'}</span>
                        </div>
                    </div>
                    <div class="flex flex-wrap items-center gap-x-4 gap-y-1 text-xs text-gray-500 mt-2">
                        <span><strong>Type:</strong> ${activity.experienceType || 'N/A'}</span>
                        <span><strong>Duration:</strong> ${durationDays} Day(s)</span>
                        <span><strong>Field:</strong> ${activity.activityType || 'N/A'}</span>
                        <span><strong>Scope:</strong> ${activity.scope || 'N/A'}</span>
                        <span><strong>Engagement:</strong> ${activity.engagement || 'N/A'}</span>
                    </div>
                    <div class="mt-4 flex flex-col sm:flex-row gap-4 items-start">
                        <div class="bg-blue-100 text-blue-800 text-sm font-medium px-4 py-2 rounded-lg">
                            <p class="font-bold"> Student experience</p>
                            <p>Participation in ${activity.activityName || 'this activity'}</p>
                        </div>
                        <div class="bg-green-100 text-green-800 text-sm font-medium px-4 py-2 rounded-lg">
                            <p>This experience claim is approved</p>
                        </div>
                    </div>
                </div>
            </div>`;
        }


        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            const formInputs = {
                '#experienceType': experienceTypes,
                'select[name="qe_experienceType"]': experienceTypes,
                '#scope': ["Choose Scope", ...scopeOptions],
                '#engagement': ["Choose Engagement", ...engagementOptions]
            };
            for (const selector in formInputs) {
                const elements = document.querySelectorAll(selector);
                elements.forEach(sel => {
                    sel.innerHTML = formInputs[selector].map(o => `<option>${o}</option>`).join('');
                });
            }

            const activityNameInput = document.getElementById('activityName');
            const activityNameCount = document.getElementById('activityNameCount');
            if(activityNameInput && activityNameCount) activityNameInput.addEventListener('input', () => activityNameCount.textContent = activityNameInput.value.length);
            
            const activityDetailsInput = document.getElementById('activityDetails');
            const activityDetailsCount = document.getElementById('activityDetailsCount');
            if(activityDetailsInput && activityDetailsCount) activityDetailsInput.addEventListener('input', () => activityDetailsCount.textContent = activityDetailsInput.value.length);
            
            const activityProofInput = document.getElementById('activityProof');
            const fileNameDisplay = document.getElementById('fileName');
            if(activityProofInput && fileNameDisplay) activityProofInput.addEventListener('change', () => fileNameDisplay.textContent = activityProofInput.files.length > 0 ? activityProofInput.files[0].name : 'No file chosen');
            
            const sidebarLink = document.querySelector('a[onclick*="dashboardView"]');
            showView('dashboardView', sidebarLink);
            
            allActivities.push(
                { activityName: 'Amnesty International', role: 'Student', status: 'Approved', experienceType: 'Club Membership', startDate: '2024-05-01', endDate: '2024-05-10', activityType: 'Performing Arts', scope: 'International', engagement: 'Low - (1-2 Hours)/Week'},
                { activityName: 'Debating and Recitation Society (DRUMS)', role: 'Student', status: 'Approved', experienceType: 'Event Competition', startDate: '2024-04-15', endDate: '2024-04-17', activityType: 'Mind And Precision Sports', scope: 'Section', engagement: 'Moderate (3-5 Hours) / Week'}
            );
        });
    </script>
</body>
</html>
